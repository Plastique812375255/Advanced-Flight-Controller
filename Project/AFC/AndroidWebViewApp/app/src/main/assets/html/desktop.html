<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ¨æ€æ¡Œé¢</title>
    <style>
        /* åŸºæœ¬æ ·å¼ */
        body, html {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        /* å®¹å™¨æ ·å¼ */
        #desktop {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f0f0f0;
        }
        
        /* ç½‘æ ¼æ ·å¼ */
        .desktop-grid {
            position: relative;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            height: 95vh;
            width: calc(95vh * 2);
            aspect-ratio: 2/1;
        }
        
        /* ç¼–è¾‘æ¨¡å¼ä¸‹çš„ç½‘æ ¼ */
        .desktop-grid.edit-mode {
            background-color: #eaeaea;
            border: 2px dashed #aaa;
        }
        
        .edit-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        #exitEditModeBtn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* ç»„ä»¶æ ·å¼ */
        .widget {
            position: absolute;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .widget.selected {
            box-shadow: 0 0 0 2px #2196F3, 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .widget-header {
            padding: 8px;
            background-color: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .widget-title {
            font-weight: bold;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .widget-content {
            padding: 10px;
            height: calc(100% - 40px);
            overflow: auto;
        }
        
        /* é®ç½©å±‚ */
        #widgetMenuOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: none;
        }
        
        #widgetMenuOverlay.active {
            display: block;
        }
        
        /* ç»„ä»¶é€‰æ‹©ä¾§è¾¹èœå• */
        #widgetMenu {
            position: fixed;
            top: 0;
            right: -300px;
            width: 280px;
            height: 100vh;
            background-color: white;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            z-index: 10001;
            overflow-y: auto;
            transition: right 0.3s ease;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }
        
        #widgetMenu.active {
            right: 0;
            display: block !important;
        }
        
        .widget-menu-title {
            font-weight: bold;
            padding: 15px;
            background-color: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .widget-menu-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #888;
        }
        
        #widgetList {
            padding: 10px;
        }
        
        .widget-option {
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            border-radius: 6px;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .widget-option:hover {
            background-color: #f0f0f0;
            border-color: #ddd;
        }
        
        .widget-option-icon {
            background-color: #e0e0e0;
            color: #666;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .system-widget .widget-option-icon {
            background-color: #bbdefb;
            color: #1976d2;
        }
        
        .user-widget .widget-option-icon {
            background-color: #c8e6c9;
            color: #388e3c;
        }
        
        /* åˆ é™¤åŒºåŸŸæ ·å¼ */
        #deleteZone {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: 60px;
            background: linear-gradient(to bottom, rgba(255, 0, 0, 0.8), rgba(255, 0, 0, 0.5));
            z-index: 10002;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: pulse 2s infinite;
            transition: all 0.3s ease;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        #deleteZone.drag-over {
            background: linear-gradient(to bottom, rgb(255, 0, 0), rgba(255, 0, 0, 0.7));
            height: 80px;
        }
        
        .trash-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .delete-text {
            color: white;
            font-weight: bold;
            font-size: 18px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        @keyframes pulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }
        
        /* AFCèœå•æ ·å¼ */
        #afcMenuOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: none;
        }
        
        #afcMenu {
            position: fixed;
            top: 0;
            right: -300px;
            width: 280px;
            height: 100vh;
            background-color: white;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            z-index: 10001;
            overflow-y: auto;
            transition: right 0.3s ease;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }
        
        #afcMenuList {
            padding: 10px;
        }
        
        .menu-option {
            padding: 15px;
            margin-bottom: 8px;
            cursor: pointer;
            border-radius: 6px;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }
        
        .menu-option:hover,
        .menu-option:active {
            background-color: #e8e8e8;
            border-color: #ddd;
        }
        
        .menu-icon {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e0e0e0;
            border-radius: 50%;
            color: #555;
            font-weight: bold;
            font-size: 14px;
        }
        
        /* åŠŸèƒ½æŒ‰é’®æ ·å¼ */
        .widget-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px;
            margin-left: 5px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        
        .widget-button:hover {
            opacity: 1;
        }
        
        /* å°ºå¯¸è°ƒæ•´å¥æŸ„ */
        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #2196F3;
            border-radius: 50%;
            bottom: 2px;
            right: 2px;
            cursor: nwse-resize;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .selected .resize-handle {
            opacity: 1;
        }
        
        .instructions {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 80%;
        }
        
        /* æç¤ºæ ·å¼ */
        .instructions h3 {
            margin-top: 0;
        }
        
        .instructions p {
            margin-bottom: 5px;
        }
    </style>
    <!-- å¼•å…¥åŸºç±»å’Œç»„ä»¶ç®¡ç†å™¨ -->
    <script>
    /**
     * ç»„ä»¶åŸºç±» - æ‰€æœ‰ç»„ä»¶éƒ½åº”è¯¥ç»§æ‰¿è¿™ä¸ªç±»
     */
    class BaseWidget {
        constructor(config) {
            this.config = config || {};
            this.element = null;
        }
        
        /**
         * è·å–ç»„ä»¶ID
         */
        getId() {
            return this.constructor.getMetadata().id;
        }
        
        /**
         * åˆ›å»ºç»„ä»¶DOMå…ƒç´ 
         */
        createDOMElement() {
            this.element = document.createElement('div');
            this.element.className = 'widget';
            this.element.dataset.widgetId = this.getId();
            this.element.dataset.col = this.config.col;
            this.element.dataset.row = this.config.row;
            this.element.dataset.width = this.config.width;
            this.element.dataset.height = this.config.height;
            
            // æ·»åŠ ç»„ä»¶å†…å®¹
            this.renderContent();
            
            return this.element;
        }
        
        /**
         * æ¸²æŸ“ç»„ä»¶å†…å®¹ (å­ç±»åº”è¯¥é‡å†™è¿™ä¸ªæ–¹æ³•)
         */
        renderContent() {
            this.element.innerHTML = `<div class="widget-content">${this.constructor.getMetadata().name}</div>`;
        }
        
        /**
         * æ›´æ–°ç»„ä»¶é…ç½®
         */
        updateConfig(newConfig) {
            this.config = { ...this.config, ...newConfig };
            
            // æ›´æ–°å…ƒç´ å±æ€§
            if (this.element) {
                this.element.dataset.col = this.config.col;
                this.element.dataset.row = this.config.row;
                this.element.dataset.width = this.config.width;
                this.element.dataset.height = this.config.height;
            }
        }
        
        /**
         * è·å–ç»„ä»¶å…ƒæ•°æ® (é™æ€æ–¹æ³•ï¼Œå­ç±»å¿…é¡»é‡å†™)
         */
        static getMetadata() {
            return {
                id: 'base.widget',
                name: 'åŸºç¡€ç»„ä»¶',
                description: 'ç»„ä»¶åŸºç±»ï¼Œä¸åº”ç›´æ¥ä½¿ç”¨',
                width: 1,
                height: 1
            };
        }
    }

    // è®¾ç½®ä¸ºå…¨å±€å¯¹è±¡
    window.BaseWidget = BaseWidget;
    </script>
    <!-- å¼•å…¥ç»„ä»¶ç®¡ç†å™¨ -->
    <script src="js/widget-manager.js"></script>
    
    <!-- ç§»é™¤æ‰‹åŠ¨åŠ è½½ç»„ä»¶çš„ä»£ç ï¼Œé¿å…undefinedé”™è¯¯ -->
</head>
<body>
    <!-- åˆ é™¤ç»„ä»¶åŒºåŸŸ -->
    <div id="deleteZone">
        <div class="trash-icon">ğŸ—‘ï¸</div>
        <div class="delete-text">æ‹–åŠ¨åˆ°æ­¤å¤„åˆ é™¤ç»„ä»¶</div>
    </div>
    
    <div id="desktop">
        <!-- ç½‘æ ¼å®¹å™¨ -->
        <div id="desktopGrid" class="desktop-grid">
            <!-- ç»„ä»¶å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
        
        <!-- å¦‚æœæ²¡æœ‰ç»„ä»¶ï¼Œæ˜¾ç¤ºæŒ‡å¼• -->
        <div class="instructions">
            <h3>æ¬¢è¿ä½¿ç”¨åŠ¨æ€æ¡Œé¢</h3>
            <p>é•¿æŒ‰æ¡Œé¢è¿›å…¥ç¼–è¾‘æ¨¡å¼</p>
            <p>åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹å¯ä»¥ç§»åŠ¨ã€åˆ é™¤å’Œæ·»åŠ ç»„ä»¶</p>
            <p>åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ç‚¹å‡»ç©ºç™½å¤„å¯ä»¥æ·»åŠ æ–°ç»„ä»¶</p>
            <p>å®Œæˆåç‚¹å‡»å·¦ä¸Šè§’çš„é€€å‡ºæŒ‰é’®</p>
        </div>
        
        <!-- ç¼–è¾‘æ¨¡å¼æ§åˆ¶åŒº -->
        <div class="edit-controls" style="display: none;">
            <button id="exitEditModeBtn" style="background-color: #f44336; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-weight: bold; cursor: pointer;">é€€å‡ºç¼–è¾‘</button>
        </div>
    </div>
    
    <!-- é®ç½©å±‚ -->
    <div id="widgetMenuOverlay"></div>
    
    <!-- ç»„ä»¶é€‰æ‹©èœå• -->
    <div id="widgetMenu">
        <div class="widget-menu-title">
            æ·»åŠ ç»„ä»¶
            <button class="widget-menu-close" onclick="hideWidgetMenu()">Ã—</button>
        </div>
        <div id="widgetList"></div>
    </div>
    
    <!-- AFCä¾§è¾¹èœå•é®ç½©å±‚ -->
    <div id="afcMenuOverlay" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0, 0, 0, 0.5); z-index: 10000; display: none;"></div>
    
    <!-- AFCä¾§è¾¹èœå• -->
    <div id="afcMenu" style="position: fixed; top: 0; right: -300px; width: 280px; height: 100vh; background-color: white; box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); z-index: 10001; overflow-y: auto; transition: right 0.3s ease;">
        <div class="widget-menu-title">
            AFC
            <button class="widget-menu-close" onclick="hideAfcMenu()">Ã—</button>
        </div>
        <div id="afcMenuList">
            <div class="menu-option"><div class="menu-icon">ğŸ“¡</div>å¯¹é¢‘</div>
            <div class="menu-option"><div class="menu-icon">ğŸŒ</div>è¯­è¨€</div>
            <div class="menu-option"><div class="menu-icon">âš™ï¸</div>ç³»ç»Ÿè®¾ç½®</div>
            <div class="menu-option"><div class="menu-icon">ğŸ‘¤</div>è´¦å·ä¸åŒæ­¥</div>
            <div class="menu-option"><div class="menu-icon">ğŸ›’</div>åº”ç”¨å•†åº—</div>
            <div class="menu-option"><div class="menu-icon">ğŸ¨</div>ä¸»é¢˜è®¾ç½®</div>
            <div class="menu-option"><div class="menu-icon">â„¹ï¸</div>å…³äºæˆ‘ä»¬</div>
            <div class="menu-option"><div class="menu-icon">â“</div>å¸®åŠ©ä¸­å¿ƒ</div>
            <div class="menu-option"><div class="menu-icon">ğŸ”„</div>ç‰ˆæœ¬æ›´æ–°</div>
            <div class="menu-option"><div class="menu-icon">ğŸ””</div>é€šçŸ¥è®¾ç½®</div>
            <div class="menu-option"><div class="menu-icon">ğŸ”’</div>éšç§è®¾ç½®</div>
            <div class="menu-option"><div class="menu-icon">ğŸ’¾</div>æ•°æ®å¤‡ä»½</div>
            <div class="menu-option"><div class="menu-icon">ğŸ“¶</div>ç½‘ç»œè®¾ç½®</div>
            <div class="menu-option"><div class="menu-icon">ğŸ’½</div>å­˜å‚¨ç®¡ç†</div>
            <div class="menu-option"><div class="menu-icon">ğŸ”§</div>å¼€å‘è€…é€‰é¡¹</div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // ç§»é™¤è¯´æ˜æ–‡æœ¬
            const instructions = document.querySelector('.instructions');
            if (instructions) {
                instructions.style.display = 'none';
            }
            
            const desktopGrid = document.getElementById('desktopGrid');
            let editMode = false;
            let longPressTimer;
            let draggedWidget = null;
            let initialX, initialY;
            let initialLeft, initialTop;
            let isDragging = false; // è·Ÿè¸ªæ˜¯å¦æ­£åœ¨æ‹–æ‹½
            
            // å¼ºåˆ¶éšè—åˆ é™¤åŒºåŸŸ
            const deleteZone = document.getElementById('deleteZone');
            if (deleteZone) {
                deleteZone.style.display = 'none';
                deleteZone.classList.remove('drag-over');
            }
            
            // åˆ›å»ºç»„ä»¶ç®¡ç†å™¨
            const widgetManager = new WidgetManager(desktopGrid);
            
            // è°ƒæ•´æ¡Œé¢å°ºå¯¸
            function resizeDesktop() {
                console.log('è°ƒæ•´æ¡Œé¢å°ºå¯¸');
                
                // ç®€åŒ–å¸ƒå±€è®¡ç®—ï¼Œaspect-ratio CSSå±æ€§ä¼šè‡ªåŠ¨ä¿æŒ12:6çš„å®½é«˜æ¯”
                // æ‰€ä»¥ä¸éœ€è¦æ‰‹åŠ¨è®¡ç®—å’Œè®¾ç½®å°ºå¯¸
                
                // è·å–å®é™…å°ºå¯¸
                const gridWidth = desktopGrid.clientWidth;
                const gridHeight = desktopGrid.clientHeight;
                console.log(`ç½‘æ ¼å®é™…å°ºå¯¸: ${gridWidth}x${gridHeight}`);
                
                // è®¡ç®—æ ¼å­å¤§å°å¹¶æ›´æ–°ç»„ä»¶ç®¡ç†å™¨
                const cellWidth = gridWidth / 12;
                const cellHeight = gridHeight / 6;
                console.log(`å•å…ƒæ ¼å°ºå¯¸: ${cellWidth}x${cellHeight}`);
                
                widgetManager.setCellSize(cellWidth, cellHeight);
            }
            
            // åˆå§‹åŒ–ç»„ä»¶ç®¡ç†å™¨å’Œè°ƒæ•´å¤§å°
            try {
                // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                function removeLoading() {
                    const loading = desktopGrid.querySelector('.loading');
                    if (loading) {
                        loading.remove();
                    }
                }
                
                // åˆå§‹åŒ–ç»„ä»¶ç®¡ç†å™¨
                await widgetManager.init();
                removeLoading();
                
                // è°ƒæ•´å¤§å°
                resizeDesktop();
                
                // ç›‘å¬çª—å£å¤§å°å˜åŒ–
                window.addEventListener('resize', resizeDesktop);
                
                // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
                initDragFunctionality();
                
                // åˆå§‹åŒ–æ»‘åŠ¨æ‰‹åŠ¿è¯†åˆ«
                initSwipeGesture();
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                desktopGrid.innerHTML = `
                    <div class="loading">
                        <div style="color: red">åŠ è½½å¤±è´¥</div>
                        <div>${error.message}</div>
                    </div>
                `;
            }
            
            function initDragFunctionality() {
                console.log('åˆå§‹åŒ–é•¿æŒ‰è¿›å…¥ç¼–è¾‘æ¨¡å¼åŠŸèƒ½');
                
                // é•¿æŒ‰è¿›å…¥ç¼–è¾‘æ¨¡å¼
                desktopGrid.addEventListener('mousedown', function(e) {
                    console.log('é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶è§¦å‘');
                    // åªæœ‰åœ¨éç¼–è¾‘æ¨¡å¼ä¸‹æ‰å¯åŠ¨é•¿æŒ‰è®¡æ—¶å™¨
                    if (!editMode) {
                        longPressTimer = setTimeout(function() {
                            console.log('é•¿æŒ‰è®¡æ—¶å™¨æ‰§è¡Œï¼Œè¿›å…¥ç¼–è¾‘æ¨¡å¼');
                            enterEditMode();
                        }, 500); // 500msé•¿æŒ‰æ—¶é—´
                    }
                });
                
                desktopGrid.addEventListener('touchstart', function(e) {
                    console.log('è§¦æ‘¸å¼€å§‹äº‹ä»¶è§¦å‘');
                    // åªæœ‰åœ¨éç¼–è¾‘æ¨¡å¼ä¸‹æ‰å¯åŠ¨é•¿æŒ‰è®¡æ—¶å™¨
                    if (!editMode) {
                        longPressTimer = setTimeout(function() {
                            console.log('é•¿æŒ‰è®¡æ—¶å™¨æ‰§è¡Œï¼Œè¿›å…¥ç¼–è¾‘æ¨¡å¼');
                            enterEditMode();
                        }, 500); // 500msé•¿æŒ‰æ—¶é—´
                    }
                });
                
                // å–æ¶ˆé•¿æŒ‰
                desktopGrid.addEventListener('mouseup', function() {
                    clearTimeout(longPressTimer);
                });
                
                desktopGrid.addEventListener('touchend', function() {
                    clearTimeout(longPressTimer);
                });
                
                desktopGrid.addEventListener('mouseleave', function() {
                    clearTimeout(longPressTimer);
                });
                
                // å·¦ä¸Šè§’é€€å‡ºæŒ‰é’®
                const exitEditBtn = document.getElementById('exitEditModeBtn');
                if (exitEditBtn) {
                    exitEditBtn.addEventListener('click', function(e) {
                        exitEditMode();
                        e.stopPropagation(); // é˜²æ­¢è§¦å‘å…¶ä»–ç‚¹å‡»äº‹ä»¶
                    });
                }
                
                // ç‚¹å‡»ç©ºç™½åŒºåŸŸæ·»åŠ ç»„ä»¶
                desktopGrid.addEventListener('click', function(e) {
                    // åªåœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ä¸”ç‚¹å‡»çš„ä¸æ˜¯ç»„ä»¶å’Œæ§åˆ¶æŒ‰é’®æ—¶æ˜¾ç¤ºç»„ä»¶èœå•
                    if (editMode && 
                        !e.target.closest('.widget') && 
                        !e.target.closest('.edit-controls') && 
                        !e.target.closest('#widgetMenu')) {
                        
                        showWidgetMenu(e.clientX, e.clientY);
                    }
                });
                
                // è§¦æ‘¸ç‰ˆæœ¬
                desktopGrid.addEventListener('touchend', function(e) {
                    // ç¡®ä¿è¿™æ˜¯ä¸€ä¸ªè½»è§¦è€Œä¸æ˜¯æ‹–åŠ¨ç»“æŸ
                    if (editMode && 
                        !isDragging && 
                        !e.target.closest('.widget') && 
                        !e.target.closest('.edit-controls') && 
                        !e.target.closest('#widgetMenu')) {
                        
                        const touch = e.changedTouches[0];
                        showWidgetMenu(touch.clientX, touch.clientY);
                    }
                });
                
                // æ·»åŠ ç»„ä»¶æ‹–æ‹½äº‹ä»¶ - ä½¿ç”¨HTML5æ‹–æ”¾API
                desktopGrid.addEventListener('mousedown', function(e) {
                    // åœ¨æ‹–æ‹½å¼€å§‹æ—¶ä¸åšä»»ä½•äº‹æƒ…ï¼Œæ‹–æ‹½åŠŸèƒ½ç”±draggableå±æ€§å’Œdragstartäº‹ä»¶å¤„ç†
                    // æ‰€æœ‰ç»„ä»¶åœ¨ç¼–è¾‘æ¨¡å¼ä¸­ä¼šè‡ªåŠ¨è·å¾—draggable=trueå±æ€§
                });
                
                desktopGrid.addEventListener('touchstart', function(e) {
                    // ä¹Ÿä¸åšä»»ä½•äº‹æƒ…ï¼Œæ‹–æ‹½åŠŸèƒ½ç”±draggableå±æ€§å’Œdragstartäº‹ä»¶å¤„ç†
                });
            }
            
            // è¿›å…¥ç¼–è¾‘æ¨¡å¼
            function enterEditMode() {
                console.log('è¿›å…¥ç¼–è¾‘æ¨¡å¼');
                
                // è®¾ç½®ç¼–è¾‘æ¨¡å¼æ ‡å¿—
                editMode = true;
                
                // æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®
                const exitEditBtn = document.getElementById('exitEditModeBtn');
                if (exitEditBtn) {
                    exitEditBtn.style.display = 'block';
                }
                
                // æ˜¾ç¤ºåˆ é™¤åŒºåŸŸ
                const deleteZone = document.getElementById('deleteZone');
                if (deleteZone) {
                    deleteZone.style.display = 'flex';
                }
                
                // æ·»åŠ ç¼–è¾‘æ¨¡å¼æ ·å¼
                desktopGrid.classList.add('edit-mode');
                
                // ä¸ºæ¯ä¸ªç»„ä»¶æ·»åŠ å¯æ‹–åŠ¨å±æ€§
                const widgets = document.querySelectorAll('.widget');
                widgets.forEach(widget => {
                    widget.setAttribute('draggable', 'true');
                    widget.classList.add('widget-edit-mode');
                    
                    // æ·»åŠ æ‹–æ‹½äº‹ä»¶ç›‘å¬å™¨ - PC
                    widget.addEventListener('dragstart', handleDragStart);
                    widget.addEventListener('dragend', handleDragEnd);
                    
                    // æ·»åŠ è§¦æ‘¸æ‹–æ‹½ç›‘å¬å™¨ - ç§»åŠ¨è®¾å¤‡
                    widget.addEventListener('touchstart', handleDragStart);
                });
                
                // æ·»åŠ æ–‡æ¡£çº§åˆ«çš„è§¦æ‘¸ç§»åŠ¨å’Œç»“æŸç›‘å¬
                document.addEventListener('touchmove', handleTouchMove);
                document.addEventListener('touchend', handleTouchEnd);
                
                // ä¸ºç½‘æ ¼æ·»åŠ æ‹–æ”¾åŒºåŸŸäº‹ä»¶
                desktopGrid.addEventListener('dragover', handleDragOver);
                desktopGrid.addEventListener('drop', handleDrop);
                
                // ä¸ºåˆ é™¤åŒºåŸŸæ·»åŠ æ‹–æ”¾äº‹ä»¶
                if (deleteZone) {
                    deleteZone.addEventListener('dragover', handleDeleteZoneOver);
                    deleteZone.addEventListener('dragleave', handleDeleteZoneLeave);
                    deleteZone.addEventListener('drop', handleDeleteZoneDrop);
                }
                
                // ä¿å­˜å½“å‰å¸ƒå±€ä»¥ä¾¿åœ¨å–æ¶ˆæ—¶æ¢å¤
                saveCurrentLayout();
            }
            
            // é€€å‡ºç¼–è¾‘æ¨¡å¼
            function exitEditMode() {
                console.log('é€€å‡ºç¼–è¾‘æ¨¡å¼');
                
                // å…³é—­ç¼–è¾‘æ¨¡å¼æ ‡å¿—
                editMode = false;
                
                // éšè—æ§åˆ¶æŒ‰é’®
                const exitEditBtn = document.getElementById('exitEditModeBtn');
                if (exitEditBtn) {
                    exitEditBtn.style.display = 'none';
                }
                
                // éšè—åˆ é™¤åŒºåŸŸ
                const deleteZone = document.getElementById('deleteZone');
                if (deleteZone) {
                    deleteZone.style.display = 'none';
                    deleteZone.classList.remove('drag-over');
                }
                
                // ç§»é™¤ç¼–è¾‘æ¨¡å¼æ ·å¼
                desktopGrid.classList.remove('edit-mode');
                
                // ç§»é™¤ç»„ä»¶çš„å¯æ‹–åŠ¨å±æ€§
                const widgets = document.querySelectorAll('.widget');
                widgets.forEach(widget => {
                    widget.removeAttribute('draggable');
                    widget.classList.remove('widget-edit-mode');
                    
                    // ç§»é™¤PCæ‹–æ‹½äº‹ä»¶ç›‘å¬å™¨
                    widget.removeEventListener('dragstart', handleDragStart);
                    widget.removeEventListener('dragend', handleDragEnd);
                    
                    // ç§»é™¤è§¦æ‘¸æ‹–æ‹½ç›‘å¬å™¨
                    widget.removeEventListener('touchstart', handleDragStart);
                });
                
                // ç§»é™¤æ–‡æ¡£çº§åˆ«çš„è§¦æ‘¸ç§»åŠ¨å’Œç»“æŸç›‘å¬
                document.removeEventListener('touchmove', handleTouchMove);
                document.removeEventListener('touchend', handleTouchEnd);
                
                // ç§»é™¤ç½‘æ ¼çš„æ‹–æ”¾åŒºåŸŸäº‹ä»¶
                desktopGrid.removeEventListener('dragover', handleDragOver);
                desktopGrid.removeEventListener('drop', handleDrop);
                
                // ç§»é™¤åˆ é™¤åŒºåŸŸçš„æ‹–æ”¾äº‹ä»¶
                if (deleteZone) {
                    deleteZone.removeEventListener('dragover', handleDeleteZoneOver);
                    deleteZone.removeEventListener('dragleave', handleDeleteZoneLeave);
                    deleteZone.removeEventListener('drop', handleDeleteZoneDrop);
                }
                
                // ä¿å­˜æœ€ç»ˆå¸ƒå±€
                widgetManager.saveLayout();
            }
            
            // åˆ é™¤åŒºåŸŸçš„æ‹–æ‹½äº‹ä»¶å¤„ç†
            function handleDeleteZoneOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                this.classList.add('drag-over');
            }
            
            function handleDeleteZoneLeave(e) {
                this.classList.remove('drag-over');
            }
            
            function handleDeleteZoneDrop(e) {
                e.preventDefault();
                const widgetId = e.dataTransfer.getData('text/plain');
                const widget = document.getElementById(widgetId);
                
                if (widget) {
                    console.log(`åˆ é™¤ç»„ä»¶: ${widgetId}`);
                    
                    // ä»DOMä¸­ç§»é™¤ç»„ä»¶
                    widget.remove();
                    
                    // ä»ç®¡ç†å™¨ä¸­ç§»é™¤ç»„ä»¶
                    widgetManager.removeWidget(widgetId);
                    
                    // ä¿å­˜å¸ƒå±€
                    widgetManager.saveLayout();
                }
                
                // ç§»é™¤æ‹–æ‹½æ ·å¼
                this.classList.remove('drag-over');
            }
            
            // ç»„ä»¶æ‹–æ‹½å˜é‡
            let currentDragWidget = null;
            let dragOffsetX = 0;
            let dragOffsetY = 0;
            
            // ç»„ä»¶æ‹–æ‹½å¼€å§‹ - æ”¯æŒPCå’Œç§»åŠ¨è®¾å¤‡
            function handleDragStart(e) {
                // PCè®¾å¤‡æ‹–æ‹½æ”¯æŒ
                if (e.dataTransfer) {
                    e.dataTransfer.setData('text/plain', this.id);
                    e.dataTransfer.effectAllowed = 'move';
                }
                
                this.classList.add('dragging');
                
                // è®°å½•åˆå§‹ä½ç½®
                const rect = this.getBoundingClientRect();
                
                // æ ¹æ®äº‹ä»¶ç±»å‹è·å–å®¢æˆ·ç«¯åæ ‡
                let clientX, clientY;
                if (e.type === 'touchstart') {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                
                const offsetX = clientX - rect.left;
                const offsetY = clientY - rect.top;
                
                // ä¿å­˜æ‹–æ‹½åç§»é‡
                this.dataset.dragOffsetX = offsetX;
                this.dataset.dragOffsetY = offsetY;
                
                // è®¾ç½®å½“å‰æ‹–æ‹½ç»„ä»¶å’ŒçŠ¶æ€ï¼ˆç”¨äºè§¦æ‘¸è®¾å¤‡ï¼‰
                currentDragWidget = this;
                isDragging = true;
                dragOffsetX = offsetX;
                dragOffsetY = offsetY;
                
                console.log(`å¼€å§‹æ‹–æ‹½ç»„ä»¶: ${this.id}, åç§»é‡: X=${offsetX}, Y=${offsetY}`);
                
                // é˜»æ­¢è§¦æ‘¸è®¾å¤‡ä¸Šçš„æ»šåŠ¨
                if (e.type === 'touchstart') {
                    e.preventDefault();
                }
            }
            
            // ç»„ä»¶æ‹–æ‹½ç»“æŸ
            function handleDragEnd(e) {
                this.classList.remove('dragging');
                
                // æ¸…é™¤æ‹–æ‹½æ•°æ®
                delete this.dataset.dragOffsetX;
                delete this.dataset.dragOffsetY;
                
                console.log(`ç»“æŸæ‹–æ‹½ç»„ä»¶: ${this.id}`);
            }
            
            // æ‹–æ‹½ç»è¿‡æ¡Œé¢ç½‘æ ¼
            function handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                const deleteZone = document.getElementById('deleteZone');
                if (deleteZone) {
                    deleteZone.classList.remove('drag-over');
                }
            }
            
            // åœ¨æ¡Œé¢ç½‘æ ¼ä¸Šæ”¾ç½®ç»„ä»¶
            function handleDrop(e) {
                e.preventDefault();
                
                const widgetId = e.dataTransfer.getData('text/plain');
                const widget = document.getElementById(widgetId);
                
                if (widget) {
                    // è®¡ç®—ç›¸å¯¹äºæ¡Œé¢çš„ä½ç½®
                    const gridRect = desktopGrid.getBoundingClientRect();
                    const relX = e.clientX - gridRect.left;
                    const relY = e.clientY - gridRect.top;
                    
                    // è€ƒè™‘æ‹–æ‹½åç§»é‡
                    const offsetX = parseFloat(widget.dataset.dragOffsetX || 0);
                    const offsetY = parseFloat(widget.dataset.dragOffsetY || 0);
                    
                    // è®¡ç®—å•å…ƒæ ¼å°ºå¯¸
                    const cellWidth = desktopGrid.clientWidth / 12;
                    const cellHeight = desktopGrid.clientHeight / 6;
                    
                    // è®¡ç®—è°ƒæ•´åçš„ä½ç½®
                    const adjX = relX - offsetX;
                    const adjY = relY - offsetY;
                    
                    // è®¡ç®—ç½‘æ ¼ä½ç½®
                    const col = Math.floor(adjX / cellWidth);
                    const row = Math.floor(adjY / cellHeight);
                    
                    // è·å–ç»„ä»¶å°ºå¯¸
                    const width = parseInt(widget.dataset.width);
                    const height = parseInt(widget.dataset.height);
                    
                    // ç¡®ä¿ä¸è¶…å‡ºè¾¹ç•Œ
                    const finalCol = Math.max(0, Math.min(col, 12 - width));
                    const finalRow = Math.max(0, Math.min(row, 6 - height));
                    
                    console.log(`æ”¾ç½®ç»„ä»¶: ${widgetId} åœ¨ä½ç½® åˆ—=${finalCol}, è¡Œ=${finalRow}`);
                    
                    // æ›´æ–°ä½ç½®
                    widget.style.left = `${finalCol * cellWidth}px`;
                    widget.style.top = `${finalRow * cellHeight}px`;
                    
                    // æ›´æ–°æ•°æ®å±æ€§
                    widget.dataset.col = finalCol;
                    widget.dataset.row = finalRow;
                    
                    // æ›´æ–°ç»„ä»¶é…ç½®
                    const widgetObj = widgetManager.widgets.find(w => w.getId() === widgetId);
                    if (widgetObj && widgetObj.config) {
                        widgetObj.config.col = finalCol;
                        widgetObj.config.row = finalRow;
                    }
                    
                    // è§¦å‘ä¿å­˜
                    widgetManager.saveLayout();
                }
            }
            
            // ä¿å­˜å½“å‰å¸ƒå±€ä»¥ä¾¿åœ¨å–æ¶ˆæ—¶æ¢å¤
            function saveCurrentLayout() {
                // å¯ä»¥å®ç°å¸ƒå±€çš„ä¸´æ—¶ä¿å­˜å’Œæ¢å¤
                console.log('ä¿å­˜å½“å‰å¸ƒå±€');
            }
            
            // æ˜¾ç¤ºç»„ä»¶é€‰æ‹©èœå•
            function showWidgetMenu(x, y) {
                // ä½¿ç”¨é¡¶å±‚çª—å£çš„èœå•å…ƒç´ ï¼Œè€Œä¸æ˜¯å½“å‰iframeå†…çš„
                const topWindow = window.top || window;
                let menu, overlay, widgetList;
                
                // æ£€æŸ¥é¡¶å±‚çª—å£æ˜¯å¦å­˜åœ¨èœå•å…ƒç´ 
                if (topWindow.document.getElementById('widgetMenu')) {
                    menu = topWindow.document.getElementById('widgetMenu');
                    overlay = topWindow.document.getElementById('widgetMenuOverlay');
                    widgetList = topWindow.document.getElementById('widgetList');
                } else {
                    // å¦‚æœé¡¶å±‚æ²¡æœ‰ï¼Œåˆ™åˆ›å»º
                    overlay = topWindow.document.createElement('div');
                    overlay.id = 'widgetMenuOverlay';
                    overlay.style.position = 'fixed';
                    overlay.style.top = '0';
                    overlay.style.left = '0';
                    overlay.style.width = '100vw';
                    overlay.style.height = '100vh';
                    overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                    overlay.style.zIndex = '99999';
                    
                    menu = topWindow.document.createElement('div');
                    menu.id = 'widgetMenu';
                    menu.style.position = 'fixed';
                    menu.style.top = '0';
                    menu.style.right = '0';
                    menu.style.width = '280px';
                    menu.style.height = '100vh';
                    menu.style.backgroundColor = 'white';
                    menu.style.boxShadow = '0 0 15px rgba(0, 0, 0, 0.2)';
                    menu.style.zIndex = '100000';
                    menu.style.overflowY = 'auto';
                    
                    const titleDiv = topWindow.document.createElement('div');
                    titleDiv.style.fontWeight = 'bold';
                    titleDiv.style.padding = '15px';
                    titleDiv.style.backgroundColor = '#f5f5f5';
                    titleDiv.style.borderBottom = '1px solid #e0e0e0';
                    titleDiv.style.display = 'flex';
                    titleDiv.style.justifyContent = 'space-between';
                    titleDiv.style.alignItems = 'center';
                    titleDiv.innerHTML = 'æ·»åŠ ç»„ä»¶';
                    
                    const closeBtn = topWindow.document.createElement('button');
                    closeBtn.style.background = 'none';
                    closeBtn.style.border = 'none';
                    closeBtn.style.fontSize = '18px';
                    closeBtn.style.cursor = 'pointer';
                    closeBtn.style.color = '#888';
                    closeBtn.innerHTML = 'Ã—';
                    closeBtn.onclick = hideWidgetMenu;
                    
                    titleDiv.appendChild(closeBtn);
                    menu.appendChild(titleDiv);
                    
                    widgetList = topWindow.document.createElement('div');
                    widgetList.id = 'widgetList';
                    widgetList.style.padding = '10px';
                    menu.appendChild(widgetList);
                    
                    topWindow.document.body.appendChild(overlay);
                    topWindow.document.body.appendChild(menu);
                }
                
                // æ¸…ç©ºç°æœ‰é€‰é¡¹
                if (widgetList) {
                    widgetList.innerHTML = '';
                    
                    // æ˜¾ç¤ºç¡¬ç¼–ç çš„ç»„ä»¶é€‰é¡¹
                    widgetList.innerHTML = `
                        <div class="widget-option system-widget" data-widget-id="system.small">
                            <div class="widget-option-icon">1x1</div>
                            <div>å°ç»„ä»¶</div>
                        </div>
                        <div class="widget-option system-widget" data-widget-id="system.medium">
                            <div class="widget-option-icon">3x1</div>
                            <div>ä¸­ç»„ä»¶</div>
                        </div>
                        <div class="widget-option system-widget" data-widget-id="system.large">
                            <div class="widget-option-icon">4x2</div>
                            <div>å¤§ç»„ä»¶</div>
                        </div>
                        <div class="widget-option user-widget" data-widget-id="user.custom">
                            <div class="widget-option-icon">2x2</div>
                            <div>è‡ªå®šä¹‰ç»„ä»¶</div>
                        </div>
                        <div class="widget-option system-widget" data-widget-id="system.model-name">
                            <div class="widget-option-icon">3x1</div>
                            <div>æ¨¡å‹åç§°</div>
                        </div>
                        <div class="widget-option system-widget" data-widget-id="system.model-image">
                            <div class="widget-option-icon">4x3</div>
                            <div>æ¨¡å‹å›¾ç‰‡</div>
                        </div>
                    `;
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    const options = widgetList.querySelectorAll('.widget-option');
                    options.forEach(option => {
                        option.addEventListener('click', function() {
                            const widgetId = this.dataset.widgetId;
                            addWidgetAtPosition(widgetId, x, y);
                            hideWidgetMenu();
                        });
                    });
                }
                
                // æ˜¾ç¤ºèœå•
                if (overlay && menu) {
                    overlay.style.display = 'block';
                    menu.style.right = '0';
                    
                    // æ·»åŠ é®ç½©ç‚¹å‡»äº‹ä»¶
                    overlay.onclick = hideWidgetMenu;
                }
            }
            
            // åœ¨æŒ‡å®šä½ç½®æ·»åŠ ç»„ä»¶
            function addWidgetAtPosition(widgetId, clientX, clientY) {
                console.log(`æ·»åŠ ç»„ä»¶: ${widgetId} åœ¨ä½ç½® X:${clientX}, Y:${clientY}`);
                
                // è®¡ç®—ç›¸å¯¹äºæ¡Œé¢çš„ä½ç½®
                const gridRect = desktopGrid.getBoundingClientRect();
                const relX = clientX - gridRect.left;
                const relY = clientY - gridRect.top;
                console.log(`ç›¸å¯¹ä½ç½®: X:${relX}, Y:${relY}`);
                
                // è®¡ç®—å•å…ƒæ ¼å°ºå¯¸
                const cellWidth = desktopGrid.clientWidth / 12;
                const cellHeight = desktopGrid.clientHeight / 6;
                console.log(`å•å…ƒæ ¼å°ºå¯¸: å®½åº¦:${cellWidth}, é«˜åº¦:${cellHeight}`);
                
                // è®¡ç®—å•å…ƒæ ¼ä½ç½®ï¼ˆä»0å¼€å§‹ï¼‰
                const col = Math.floor(relX / cellWidth);
                const row = Math.floor(relY / cellHeight);
                console.log(`ç½‘æ ¼ä½ç½®: åˆ—:${col}, è¡Œ:${row}`);
                
                // è·å–ç»„ä»¶é»˜è®¤å°ºå¯¸
                let width = 1;
                let height = 1;
                
                // ä½¿ç”¨ç¡¬ç¼–ç çš„å°ºå¯¸
                if (widgetId === 'system.small') {
                    width = 1; height = 1;
                } else if (widgetId === 'system.medium') {
                    width = 3; height = 1;
                } else if (widgetId === 'system.large') {
                    width = 4; height = 2;
                } else if (widgetId === 'user.custom') {
                    width = 2; height = 2;
                } else if (widgetId === 'system.model-name') {
                    width = 3; height = 1;
                } else if (widgetId === 'system.model-image') {
                    width = 4; height = 3;
                }
                console.log(`ä½¿ç”¨ç¡¬ç¼–ç å°ºå¯¸: ${width}x${height}`);
                
                // ç¡®ä¿ç»„ä»¶ä¸ä¼šè¶…å‡ºç½‘æ ¼è¾¹ç•Œ
                const finalCol = Math.max(0, Math.min(col, 12 - width));
                const finalRow = Math.max(0, Math.min(row, 6 - height));
                console.log(`æœ€ç»ˆä½ç½®: åˆ—:${finalCol}, è¡Œ:${finalRow}`);
                
                // åˆ›å»ºç»„ä»¶é…ç½®
                const config = {
                    widgetId: widgetId,
                    col: finalCol,
                    row: finalRow,
                    width: width,
                    height: height
                };
                
                // åˆ›å»ºDIVå…ƒç´ 
                const element = document.createElement('div');
                element.className = 'widget';
                element.id = 'widget_' + Date.now(); // ç”Ÿæˆå”¯ä¸€ID
                element.dataset.widgetId = widgetId;
                element.dataset.col = finalCol;
                element.dataset.row = finalRow;
                element.dataset.width = width;
                element.dataset.height = height;
                
                // è®¾ç½®ä½ç½®å’Œå°ºå¯¸
                element.style.width = `${cellWidth * width - 5}px`;
                element.style.height = `${cellHeight * height - 5}px`;
                element.style.left = `${finalCol * cellWidth}px`;
                element.style.top = `${finalRow * cellHeight}px`;
                
                // æ·»åŠ å†…å®¹
                let color = '#f44336'; // çº¢è‰² (å°)
                let title = 'å°ç»„ä»¶';
                
                if (widgetId === 'system.medium') {
                    color = '#4caf50'; // ç»¿è‰² (ä¸­)
                    title = 'ä¸­ç»„ä»¶';
                } else if (widgetId === 'system.large') {
                    color = '#ffc107'; // é»„è‰² (å¤§)
                    title = 'å¤§ç»„ä»¶';
                } else if (widgetId === 'user.custom') {
                    color = '#2196F3'; // è“è‰² (è‡ªå®šä¹‰)
                    title = 'è‡ªå®šä¹‰ç»„ä»¶';
                } else if (widgetId === 'system.model-name') {
                    color = '#9c27b0'; // ç´«è‰² (æ¨¡å‹åç§°)
                    title = 'æ¨¡å‹åç§°';
                } else if (widgetId === 'system.model-image') {
                    color = '#ff9800'; // æ©™è‰² (æ¨¡å‹å›¾ç‰‡)
                    title = 'æ¨¡å‹å›¾ç‰‡';
                }
                
                element.innerHTML = `
                    <div class="widget-content" style="display: flex; align-items: center; justify-content: center; height: 100%;">
                        <div style="text-align: center; color: ${color}; font-weight: bold;">${width}x${height}</div>
                    </div>
                `;
                
                // æ·»åŠ åˆ°æ¡Œé¢
                desktopGrid.appendChild(element);
                
                // åˆ›å»ºä¸€ä¸ªç®€å•çš„ç»„ä»¶å¯¹è±¡ç”¨äºä¿å­˜
                const widget = {
                    getId: () => widgetId,
                    config: config,
                    element: element
                };
                
                // æ·»åŠ åˆ°ç»„ä»¶ç®¡ç†å™¨
                widgetManager.widgets.push(widget);
                
                // ä¿å­˜å¸ƒå±€
                widgetManager.saveLayout();
                
                // åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹æ·»åŠ æ‹–æ‹½åŠŸèƒ½
                if (editMode) {
                    element.setAttribute('draggable', 'true');
                    element.classList.add('widget-edit-mode');
                    element.addEventListener('dragstart', handleDragStart);
                    element.addEventListener('dragend', handleDragEnd);
                }
                
                return widget;
            }
            
            // åˆå§‹åŒ–æ»‘åŠ¨æ‰‹åŠ¿è¯†åˆ«
            function initSwipeGesture() {
                let startX = 0;
                let startTime = 0;
                const minDistance = 100; // æœ€å°æ»‘åŠ¨è·ç¦»
                const maxTime = 500; // æœ€å¤§æ»‘åŠ¨æ—¶é—´ (æ¯«ç§’)
                
                // æ·»åŠ æµ‹è¯•æŒ‰é’®ï¼ˆä»…ç”¨äºè°ƒè¯•ï¼‰
                const testBtn = document.createElement('button');
                testBtn.textContent = 'æµ‹è¯•AFCèœå•';
                testBtn.style.position = 'fixed';
                testBtn.style.bottom = '10px';
                testBtn.style.right = '10px';
                testBtn.style.zIndex = '9999';
                testBtn.style.padding = '10px';
                testBtn.style.backgroundColor = '#4CAF50';
                testBtn.style.color = 'white';
                testBtn.style.border = 'none';
                testBtn.style.borderRadius = '5px';
                
                testBtn.onclick = function() {
                    console.log('æµ‹è¯•æŒ‰é’®ç‚¹å‡»');
                    showAfcMenu();
                };
                
                document.body.appendChild(testBtn);
                
                // æ»‘åŠ¨å¼€å§‹æ—¶è®°å½•ä½ç½®å’Œæ—¶é—´
                function handleTouchStart(e) {
                    console.log('è§¦æ‘¸å¼€å§‹');
                    // åªæœ‰åœ¨æœªå¤„äºç¼–è¾‘æ¨¡å¼ä¸”æ²¡æœ‰å…¶ä»–èœå•æ˜¾ç¤ºæ—¶æ‰å¯ç”¨æ»‘åŠ¨
                    const widgetMenu = document.getElementById('widgetMenu');
                    const afcMenu = document.getElementById('afcMenu');
                    
                    if (editMode) {
                        console.log('ç¼–è¾‘æ¨¡å¼ä¸‹ä¸å“åº”æ»‘åŠ¨æ‰‹åŠ¿');
                        return;
                    }
                    
                    if ((widgetMenu && widgetMenu.style.right === '0px')) {
                        console.log('ç»„ä»¶èœå•å·²æ‰“å¼€ï¼Œä¸å“åº”æ»‘åŠ¨æ‰‹åŠ¿');
                        return;
                    }
                    
                    if ((afcMenu && afcMenu.style.right === '0px')) {
                        console.log('AFCèœå•å·²æ‰“å¼€ï¼Œä¸å“åº”æ»‘åŠ¨æ‰‹åŠ¿');
                        return;
                    }
                    
                    startX = e.touches[0].clientX;
                    startTime = Date.now();
                    console.log(`è®°å½•èµ·å§‹ä½ç½®: X=${startX}, æ—¶é—´=${startTime}`);
                }
                
                // æ»‘åŠ¨ç»“æŸæ—¶æ£€æŸ¥æ˜¯å¦ç¬¦åˆå·¦æ»‘æ¡ä»¶
                function handleTouchEnd(e) {
                    console.log('è§¦æ‘¸ç»“æŸ');
                    // åªæœ‰åœ¨æœªå¤„äºç¼–è¾‘æ¨¡å¼ä¸”æ²¡æœ‰å…¶ä»–èœå•æ˜¾ç¤ºæ—¶æ‰å¯ç”¨æ»‘åŠ¨
                    const widgetMenu = document.getElementById('widgetMenu');
                    const afcMenu = document.getElementById('afcMenu');
                    
                    if (editMode || 
                        (widgetMenu && widgetMenu.style.right === '0px') ||
                        (afcMenu && afcMenu.style.right === '0px')) {
                        console.log('å½“å‰çŠ¶æ€ä¸å“åº”æ»‘åŠ¨æ‰‹åŠ¿');
                        return;
                    }
                    
                    // ç¡®ä¿è¿™æ˜¯ä¸€æ¬¡å•æŒ‡æ»‘åŠ¨
                    if (e.changedTouches.length !== 1) {
                        console.log('éå•æŒ‡æ»‘åŠ¨ï¼Œå¿½ç•¥');
                        return;
                    }
                    
                    const endX = e.changedTouches[0].clientX;
                    const endTime = Date.now();
                    const deltaX = endX - startX;
                    const deltaTime = endTime - startTime;
                    
                    console.log(`æ»‘åŠ¨è·ç¦»: ${deltaX}px, æ—¶é—´: ${deltaTime}ms`);
                    console.log(`åˆ¤æ–­æ¡ä»¶: è·ç¦»éœ€å¤§äº${minDistance}px, æ—¶é—´éœ€å°äº${maxTime}ms`);
                    
                    // å¦‚æœæ˜¯ä»å³å‘å·¦çš„å¿«é€Ÿæ»‘åŠ¨ï¼Œæ˜¾ç¤ºAFCèœå•
                    if (deltaX < -minDistance && deltaTime < maxTime) {
                        console.log('æ£€æµ‹åˆ°å·¦æ»‘æ‰‹åŠ¿ï¼Œæ˜¾ç¤ºAFCèœå•');
                        showAfcMenu();
                    }
                    
                    // å¦‚æœæ˜¯ä»å·¦å‘å³çš„å¿«é€Ÿæ»‘åŠ¨ï¼Œéšè—AFCèœå•
                    if (deltaX > minDistance && deltaTime < maxTime) {
                        const menu = document.getElementById('afcMenu');
                        if (menu && menu.style.right === '0px') {
                            console.log('æ£€æµ‹åˆ°å³æ»‘æ‰‹åŠ¿ï¼Œéšè—AFCèœå•');
                            hideAfcMenu();
                        }
                    }
                }
                
                // æ·»åŠ è§¦æ‘¸äº‹ä»¶ç›‘å¬
                document.addEventListener('touchstart', handleTouchStart, { passive: true });
                document.addEventListener('touchend', handleTouchEnd, { passive: true });
                
                console.log('æ»‘åŠ¨æ‰‹åŠ¿è¯†åˆ«å·²åˆå§‹åŒ–');
            }
            
            // æ˜¾ç¤ºAFCèœå•
            function showAfcMenu() {
                console.log('æ˜¾ç¤ºAFCèœå•');
                
                // ç›´æ¥è·å–å…ƒç´ 
                let menu = document.getElementById('afcMenu');
                let overlay = document.getElementById('afcMenuOverlay');
                
                if (!menu || !overlay) {
                    console.error('AFCèœå•å…ƒç´ ä¸å­˜åœ¨');
                    return;
                }
                
                console.log('æ‰¾åˆ°AFCèœå•å…ƒç´ ï¼Œå‡†å¤‡æ˜¾ç¤º');
                
                // æ˜¾ç¤ºèœå•å’Œé®ç½©
                overlay.style.display = 'block';
                menu.style.right = '0';
                
                // æ·»åŠ é®ç½©ç‚¹å‡»äº‹ä»¶
                overlay.onclick = hideAfcMenu;
                
                console.log('AFCèœå•å·²æ˜¾ç¤º');
            }
            
            // éšè—AFCèœå•
            function hideAfcMenu() {
                console.log('éšè—AFCèœå•');
                
                // ç›´æ¥è·å–å…ƒç´ 
                const menu = document.getElementById('afcMenu');
                const overlay = document.getElementById('afcMenuOverlay');
                
                if (!menu || !overlay) {
                    console.error('AFCèœå•å…ƒç´ ä¸å­˜åœ¨');
                    return;
                }
                
                menu.style.right = '-300px';
                overlay.style.display = 'none';
                
                console.log('AFCèœå•å·²éšè—');
            }
            
            // éšè—ç»„ä»¶é€‰æ‹©èœå•
            function hideWidgetMenu() {
                const topWindow = window.top || window;
                
                // å°è¯•è·å–é¡¶å±‚çª—å£çš„èœå•å…ƒç´ 
                const menu = topWindow.document.getElementById('widgetMenu');
                const overlay = topWindow.document.getElementById('widgetMenuOverlay');
                
                if (menu && overlay) {
                    // ä½¿ç”¨CSSæ ·å¼éšè—
                    menu.style.right = '-300px';
                    overlay.style.display = 'none';
                }
                
                console.log('éšè—ç»„ä»¶é€‰æ‹©èœå•');
            }
            
            // è§¦æ‘¸æ‹–æ‹½å¤„ç† - ç§»åŠ¨
            function handleTouchMove(e) {
                // å¦‚æœæ²¡æœ‰æ­£åœ¨æ‹–æ‹½çš„ç»„ä»¶ï¼Œç›´æ¥è¿”å›
                if (!isDragging || !currentDragWidget) {
                    return;
                }
                
                e.preventDefault(); // é˜»æ­¢æ»šåŠ¨
                
                // è·å–å½“å‰è§¦æ‘¸ä½ç½®
                const touch = e.touches[0];
                const clientX = touch.clientX;
                const clientY = touch.clientY;
                
                // è®¡ç®—ç›¸å¯¹äºæ¡Œé¢çš„ä½ç½®
                const gridRect = desktopGrid.getBoundingClientRect();
                const relX = clientX - gridRect.left;
                const relY = clientY - gridRect.top;
                
                // è€ƒè™‘æ‹–æ‹½åç§»é‡
                const adjX = relX - dragOffsetX;
                const adjY = relY - dragOffsetY;
                
                // æ£€æŸ¥æ˜¯å¦åœ¨åˆ é™¤åŒºåŸŸä¸Šæ–¹
                const deleteZone = document.getElementById('deleteZone');
                if (deleteZone) {
                    const deleteRect = deleteZone.getBoundingClientRect();
                    if (clientY >= deleteRect.top && clientY <= deleteRect.bottom &&
                        clientX >= deleteRect.left && clientX <= deleteRect.right) {
                        deleteZone.classList.add('drag-over');
                    } else {
                        deleteZone.classList.remove('drag-over');
                    }
                }
                
                // è®¡ç®—å•å…ƒæ ¼å°ºå¯¸
                const cellWidth = desktopGrid.clientWidth / 12;
                const cellHeight = desktopGrid.clientHeight / 6;
                
                // è®¡ç®—ç½‘æ ¼ä½ç½®
                const col = Math.floor(adjX / cellWidth);
                const row = Math.floor(adjY / cellHeight);
                
                // è·å–ç»„ä»¶å°ºå¯¸
                const width = parseInt(currentDragWidget.dataset.width);
                const height = parseInt(currentDragWidget.dataset.height);
                
                // ç¡®ä¿ä¸è¶…å‡ºè¾¹ç•Œ
                const finalCol = Math.max(0, Math.min(col, 12 - width));
                const finalRow = Math.max(0, Math.min(row, 6 - height));
                
                // æ›´æ–°ä½ç½®
                currentDragWidget.style.left = `${finalCol * cellWidth}px`;
                currentDragWidget.style.top = `${finalRow * cellHeight}px`;
                
                // æ›´æ–°æ•°æ®å±æ€§
                currentDragWidget.dataset.col = finalCol;
                currentDragWidget.dataset.row = finalRow;
            }
            
            // è§¦æ‘¸æ‹–æ‹½å¤„ç† - ç»“æŸ
            function handleTouchEnd(e) {
                // å¦‚æœæ²¡æœ‰æ­£åœ¨æ‹–æ‹½çš„ç»„ä»¶ï¼Œç›´æ¥è¿”å›
                if (!isDragging || !currentDragWidget) {
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦åœ¨åˆ é™¤åŒºåŸŸä¸Šæ–¹
                const deleteZone = document.getElementById('deleteZone');
                if (deleteZone && deleteZone.classList.contains('drag-over')) {
                    console.log(`åˆ é™¤ç»„ä»¶: ${currentDragWidget.id}`);
                    
                    // ä»DOMä¸­ç§»é™¤ç»„ä»¶
                    currentDragWidget.remove();
                    
                    // ä»ç®¡ç†å™¨ä¸­ç§»é™¤ç»„ä»¶
                    widgetManager.removeWidget(currentDragWidget.id);
                    
                    // åˆ é™¤ç»“æŸï¼Œç§»é™¤æ ·å¼
                    deleteZone.classList.remove('drag-over');
                } else {
                    // æ­£å¸¸æ”¾ç½®ï¼Œæ›´æ–°ç»„ä»¶é…ç½®
                    const widgetId = currentDragWidget.id;
                    const finalCol = parseInt(currentDragWidget.dataset.col);
                    const finalRow = parseInt(currentDragWidget.dataset.row);
                    
                    console.log(`æ”¾ç½®ç»„ä»¶: ${widgetId} åœ¨ä½ç½® åˆ—=${finalCol}, è¡Œ=${finalRow}`);
                    
                    // æ›´æ–°ç»„ä»¶é…ç½®
                    const widgetObj = widgetManager.widgets.find(w => w.getId() === widgetId);
                    if (widgetObj && widgetObj.config) {
                        widgetObj.config.col = finalCol;
                        widgetObj.config.row = finalRow;
                    }
                }
                
                // ä¿å­˜å¸ƒå±€
                widgetManager.saveLayout();
                
                // ç§»é™¤æ‹–æ‹½ç›¸å…³æ ·å¼å’ŒçŠ¶æ€
                currentDragWidget.classList.remove('dragging');
                isDragging = false;
                currentDragWidget = null;
            }
        });
    </script>
</body>
</html>