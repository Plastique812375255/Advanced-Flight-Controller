# AFC 通道计算器 - 映射模式与启用标志特性

## 特性概述

我们为AFC通道计算器添加了两个重要的新特性：

1. **映射模式 (Mapping Mode)**
   - 模式0: 相加模式 - 多个映射值相互叠加，适合模拟多个输入对同一接口的综合影响
   - 模式1: 相乘模式 - 多个映射值相互乘积，适合模拟输入之间的非线性关系
   - 模式2: 替代模式 - 当前映射值替代之前的值，适合模拟优先级较高的输入控制

2. **启用标志 (Enable Flags)**
   - 16位二进制数（以16进制表示）
   - 每一位对应一个档位是否启用该映射
   - 例如: FFFF = 全部档位启用, 5555 = 所有奇数档位启用, AAAA = 所有偶数档位启用

## 实现细节

### CSV格式

在CSV文件中，`PORT_MAP`行增加了两个参数：

```
PORT_MAP,接口ID,输入ID,方向1EXP,方向2EXP,方向1舵量,方向2舵量,偏移量,延迟,速度,映射模式,启用标志
```

- 映射模式: 0=相加, 1=相乘, 2=替代
- 启用标志: 16位二进制数（16进制表示），每位对应一个档位，1=启用，0=禁用

示例:
```
PORT_MAP,1,1,0,0,100,100,0,0,100,0,FFFF  # 接口1由输入1控制，相加模式，所有档位启用
PORT_MAP,2,1,0,0,100,100,0,5,90,1,5555   # 接口2由输入1控制，相乘模式，奇数档位启用
PORT_MAP,3,1,0,0,100,100,0,10,80,2,AAAA  # 接口3由输入1控制，替代模式，偶数档位启用
```

### 二进制格式

二进制文件中为每个映射条目增加了以下字段:

- 映射模式 (1字节) - 表示该映射使用的模式（0、1或2）
- 启用标志 (2字节) - 表示该映射在各个档位的启用状态

每个`PORT_MAP`映射条目在二进制文件中占用12字节：
1. 接口ID (1字节)
2. 输入ID (1字节)
3. 方向1EXP (1字节)
4. 方向2EXP (1字节)
5. 方向1舵量 (1字节)
6. 方向2舵量 (1字节)
7. 偏移量 (1字节 - 有符号)
8. 延迟 (2字节)
9. 速度 (1字节)
10. 映射模式 (1字节)
11. 启用标志 (2字节)

## 实用场景

### 映射模式应用

1. **相加模式 (模式0)**
   - 多个线性输入同时控制同一接口，各自的影响相加
   - 例如：在固定翼飞机中，副翼可以由方向舵和横滚两个输入共同控制

2. **相乘模式 (模式1)**
   - 一个输入的影响受另一个输入的调制
   - 例如：高速档位下减少控制灵敏度，实现速度越高，控制量需求越小

3. **替代模式 (模式2)**
   - 某些特殊情况下需要覆盖正常控制
   - 例如：紧急模式下某个接口由特定输入完全控制，忽略其他输入

### 启用标志应用

1. **不同档位使用不同控制策略**
   - 低速档位(1-8)使用一组映射，高速档位(9-16)使用另一组映射
   - 例如：`PORT_MAP,9,4,0,0,100,100,20,35,30,0,00F0`（5-8档使用相加模式）

2. **紧急控制模式**
   - 仅在特定档位启用某些关键控制
   - 例如：`PORT_MAP,10,5,0,0,100,100,0,50,0,2,8000`（仅在第16档启用）

3. **多输入多模式控制**
   - 在不同档位，同一接口由不同输入控制，或使用不同模式
   - 例如：档位1-8使用输入1控制，档位9-16使用输入2控制

## 测试与验证

为验证这些新特性，我们创建了以下测试工具:

1. **测试CSV文件** (`test_modes.csv`) - 包含各种映射模式和启用标志组合
2. **测试脚本** (`test_conversion.js`) - 验证二进制转换的正确性
3. **可视化测试工具** (`mode_test.html`) - 展示不同映射模式和启用标志的效果
4. **二进制查看器** (`bin_viewer.html`) - 分析二进制文件结构和内容

测试结果表明，新添加的映射模式和启用标志特性可以正确工作，能够在CSV和二进制格式之间准确转换，保留所有设置信息。

## 注意事项

1. 多个映射可以应用于同一个接口，但它们的效果取决于映射模式
2. 在使用替代模式时，应注意映射的顺序，因为后处理的映射会覆盖先处理的映射
3. 启用标志应根据系统实际档位数量设置，超出实际档位数量的标志位将被忽略
4. 建议对启用标志使用清晰的十六进制模式，如FFFF、5555、AAAA等，便于理解 