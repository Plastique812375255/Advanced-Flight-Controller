# 通道计算器 - 数据转换工具

通道计算器数据转换工具是一个用于将通道配置数据在CSV格式与紧凑二进制格式之间进行转换的工具集。该工具包含JavaScript模块用于转换，C程序用于读取，以及Web界面用于可视化操作。

## 功能特点

- CSV转二进制：将人类可读的CSV配置文件转换为紧凑的二进制格式
- 二进制转CSV：将二进制配置文件转换回CSV格式以便编辑
- 参数验证：验证CSV数据的格式和内容是否符合规范
- Web界面：提供直观的界面进行转换操作
- 轻量级：最小化二进制文件大小，优化设备加载速度

## 文件结构

- `csvToBinary.js` - JavaScript模块，用于在浏览器或Node.js环境中进行双向转换
- `portCalc_reader.c` - C程序，用于在设备端读取二进制配置文件
- `index.html` - 网页界面，提供用户友好的操作环境
- `portCalc_example.csv` - 示例CSV文件，展示配置格式

## 数据格式说明

### CSV格式

CSV文件包含三种类型的记录：

1. **接口数量**：
   ```
   PORT_COUNT,<数量>
   ```
   
2. **接口参数**：
   ```
   PORT_PARAM,<接口ID>,<接口类型>,<最大值>,<最小值>,[<中位值>]
   ```
   - 接口类型：0=NST(无中位点)，1=ST(有中位点)
   - 最大值和最小值：输出范围
   - 中位值：仅ST类型需要

3. **映射表**：
   ```
   PORT_MAP,<接口ID>,<输入ID>,<方向1EXP>,<方向2EXP>,<方向1舵量>,<方向2舵量>,<偏移量>
   ```
   - 输入ID：1-36
   - EXP：指数曲线参数，范围0-100
   - 舵量：输出百分比，范围0-100
   - 偏移量：输出偏移量

### 二进制格式

二进制文件使用紧凑的位域格式存储数据：

1. **文件头**：
   - 接口数量：2字节

2. **接口参数**：每个接口
   - 接口ID：1字节
   - 接口类型：1字节
   - 最大值：2字节
   - 最小值：2字节
   - 中位值：2字节（仅ST类型）

3. **映射表**：每个映射
   - 接口ID：1字节
   - 输入ID：1字节
   - 方向1EXP：1字节
   - 方向2EXP：1字节
   - 方向1舵量：1字节
   - 方向2舵量：1字节
   - 偏移量：1字节（有符号）

## 使用方法

### Web界面

1. 打开`index.html`文件
2. 使用CSV编辑器标签页创建或编辑配置
3. 验证CSV格式是否正确
4. 将CSV转换为二进制文件并下载
5. 使用二进制转换器标签页上传二进制文件并查看其内容

### JavaScript API

在浏览器中：

```javascript
// 创建二进制文件
const binaryData = window.portCalc.csvToBinary(csvText);

// 解析二进制文件
const csvText = window.portCalc.binaryToCSV(binaryData);
```

在Node.js中：

```javascript
const portCalc = require('./csvToBinary');

// 创建二进制文件
const binaryData = portCalc.csvToBinary(csvText);

// 解析二进制文件
const csvText = portCalc.binaryToCSV(binaryData);
```

### C程序

编译C程序：

```bash
gcc portCalc_reader.c -o portCalc_reader
```

使用C程序：

```bash
./portCalc_reader input.bin output.csv
```

## 注意事项

- 在编辑CSV文件时，确保接口ID按顺序排列，从1开始
- 每个接口需要有对应的参数配置
- ST类型接口必须提供中位值参数
- 推荐最大输出值不超过1000
- 输入ID范围必须在1-36之间 

# AFC 通道计算器 - 映射模式与启用标志测试

本项目包含了AFC通道计算器的映射模式与启用标志功能的测试工具和说明。

## 功能介绍

本次更新添加了两个重要特性：

1. **映射模式 (Mapping Mode)**
   - 模式0: 相加 - 多个映射值相互叠加
   - 模式1: 相乘 - 多个映射值相互乘积
   - 模式2: 替代 - 当前映射值替代之前的值

2. **启用标志 (Enable Flags)**
   - 16位二进制数（以16进制表示）
   - 每一位代表对应档位是否启用该映射
   - 例如: FFFF = 全部档位启用, 5555 = 所有奇数档位启用

## 文件说明

- `test_modes.csv`: 包含不同映射模式和启用标志的测试数据
- `test_conversion.js`: 测试二进制转换功能的脚本
- `run_test.js`: 运行测试的脚本
- `mode_test.html`: 可视化测试界面
- `bin_viewer.html`: 二进制文件查看器

## 运行测试

### 安装依赖

确保已安装Node.js环境。

### 运行二进制转换测试

1. 打开命令行终端
2. 导航到项目目录
3. 执行测试脚本:
   ```
   node run_test.js
   ```

测试脚本将执行以下操作:
- 读取 `test_modes.csv` 文件
- 解析CSV数据和分析映射模式
- 转换为二进制格式并保存到 `test_modes.bin`
- 将二进制数据转回CSV并保存到 `test_modes_restored.csv`
- 比较原始数据和恢复数据，特别是映射模式和启用标志

### 使用可视化测试工具

在浏览器中打开 `mode_test.html` 文件，可以:
- 加载测试文件
- 查看不同映射模式的统计信息
- 可视化每个映射的档位启用状态
- 模拟不同档位下的输出结果

### 查看二进制文件结构

在浏览器中打开 `bin_viewer.html` 文件，可以:
- 加载和查看二进制文件
- 以十六进制形式显示文件内容
- 分析二进制结构，包括文件头、接口参数、线性输入参数和映射表
- 统计不同映射模式的使用情况

## 数据格式说明

### CSV格式

```
# AFC 通道计算器测试文件 - 映射模式和启用标志示例

# 模型信息: 模型名称,模型ID,档位数量
MODEL_INFO,测试模型-16档,12345,16

# 接口数量
PORT_COUNT,10

# 接口参数: 接口ID,类型,最大值,最小值,[中位值]
PORT_PARAM,1,0,1000,-1000
...

# 线性输入参数: 输入ID,EXP,行程上,行程下,中位点,偏移
INPUT_PARAM,1,0,100,100,0,0
...

# 映射表: 接口ID,输入ID,方向1EXP,方向2EXP,方向1舵量,方向2舵量,偏移量,延迟,速度,映射模式,启用标志
PORT_MAP,1,1,0,0,100,100,0,0,100,0,FFFF
```

### 二进制格式

二进制文件结构:
1. 文件头 (4字节)
   - 模型ID (2字节)
   - 档位数量 (1字节)
   - 接口数量 (1字节)
2. 接口参数 (每个8字节)
3. 线性输入参数 (每个5字节)
4. 映射表 (每个12字节)
   - 其中包括1字节的映射模式和2字节的启用标志

## 测试效果

通过运行测试和使用可视化工具，您可以验证:
- 不同映射模式的效果
- 启用标志对不同档位的控制
- 二进制转换过程是否正确保留了所有映射模式和启用标志信息

## 注意事项

- 更改CSV文件中的映射模式值会影响输出计算方式
- 更改启用标志可以控制特定档位的映射启用状态
- 二进制文件和CSV文件之间的转换应当保持这些信息的一致性 